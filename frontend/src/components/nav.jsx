import React, { useState } from "react";
import { useGetProfileQuery } from "../slices/userApi";

import Navbar from "./Navbar";
import { useSelector } from "react-redux";
import { Link } from "react-router-dom";
import logo from "../assets/Logo.svg";
import menuavatar from "../assets/menu Avatar.svg";
import avatarDefault from "../assets/avatar-def.webp"; // Default avatar image
import LogoutButton from "../buttons/LogoutButton";
const Nav = () => {
  // const CLOUDINARY_URL = avatarDefault; // Default avatar URL should be set to your actual default avatar image URL
  const { userInfo } = useSelector((state) => state.auth);
  const { data: userProfile, isLoading } = useGetProfileQuery(undefined, {
    skip: !userInfo, // Skip API call if not logged in
  });

  console.log("userProfile", userProfile);

  const [dropdownVisible, setDropdownVisible] = useState(false);

  const toggleDropdown = () => {
    setDropdownVisible(!dropdownVisible);
  };

  // Robust profile photo logic
  console.log("userProfile.photo_profil", userProfile?.photo_profil);
  const profilePhoto =
    userProfile &&
    typeof userProfile.photo_profil === "string" &&
    userProfile.photo_profil.trim() &&
    userProfile.photo_profil !== "null" &&
    userProfile.photo_profil !== "undefined"&&
    userProfile.photo_profil !== "default-avatar.png"
      ? userProfile.photo_profil
      : avatarDefault;

  return (
    <header className="fixed top-0 left-0 w-full z-50 bg-transparent flex items-center justify-between pl-[82px] px-8">
      <Link to="/">
        <img src={logo} alt="Logo" className="w-[41.5px]" />
      </Link>
      <Navbar />

      <div className="w-[170px] h-10 text-white flex items-center justify-between space-x-2">
        <Link to="/my-collection">
          {" "}
          <svg
            width="16"
            height="16"
            viewBox="0 0 233 233"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M116.24 0C52.1456 0 0 52.1512 0 116.254C0 180.356 52.1452 232.507 116.24 232.507C180.335 232.507 232.494 180.356 232.494 116.254C232.494 52.1512 180.343 0 116.24 0ZM116.24 199.215C70.4953 199.215 33.2794 161.999 33.2794 116.254C33.2794 70.5089 70.4953 33.2925 116.24 33.2925C161.985 33.2925 199.201 70.5089 199.201 116.254C199.201 161.999 161.985 199.215 116.24 199.215ZM177.146 50.707C161.904 36.5348 141.733 27.6014 119.521 26.7966V6.61547C147.292 7.43578 172.502 18.6281 191.408 36.4444L177.146 50.7066L177.146 50.707ZM112.958 26.7966C90.7467 27.6014 70.5755 36.5344 55.3336 50.707L41.0756 36.4495C59.9794 18.6305 85.1883 7.43625 112.958 6.61594V26.797L112.958 26.7966ZM50.693 55.3477C36.5203 70.5895 27.5873 90.7608 26.7825 112.973H6.61594C7.43625 85.2042 18.6253 59.9958 36.4369 41.0906L50.6939 55.3477H50.693ZM26.7825 119.535C27.5873 141.747 36.5203 161.919 50.693 177.16L36.4359 191.417C18.6248 172.512 7.43578 147.304 6.61547 119.535H26.7825ZM55.3336 181.801C70.575 195.974 90.7462 204.907 112.958 205.711V225.892C85.1883 225.072 59.9798 213.878 41.0761 196.058L55.3336 181.801ZM119.521 205.711C141.733 204.907 161.904 195.973 177.146 181.801L191.408 196.063C172.503 213.879 147.293 225.072 119.521 225.892V205.711ZM181.787 177.16C195.959 161.918 204.892 141.747 205.697 119.535H225.878C225.058 147.307 213.866 172.517 196.049 191.422L181.787 177.16ZM205.697 112.973C204.892 90.7613 195.96 70.5895 181.787 55.3477L196.049 41.0855C213.866 59.9911 225.058 85.2014 225.878 112.973H205.697ZM123.136 66.0413C121.49 63.7819 119.04 62.5378 116.24 62.5378C113.46 62.5378 111.014 63.7777 109.349 66.0333L76.1592 111.191C73.9369 114.219 73.9364 118.288 76.1602 121.318L109.353 166.479C111.014 168.73 113.46 169.97 116.24 169.97C119.042 169.97 121.492 168.724 123.131 166.474L156.322 121.315C157.404 119.849 157.988 118.075 157.987 116.252C157.987 114.43 157.403 112.655 156.32 111.189L123.136 66.0408V66.0413ZM151.032 117.432L117.834 162.6C117.434 163.151 116.926 163.408 116.24 163.408C115.559 163.408 115.049 163.146 114.637 162.588L81.45 117.434C80.9156 116.706 80.9156 115.802 81.4486 115.077L114.634 69.9253C115.049 69.3628 115.56 69.1008 116.24 69.1008C116.927 69.1008 117.434 69.3572 117.834 69.9084L117.843 69.9202L151.031 115.075C151.565 115.802 151.565 116.707 151.033 117.432L151.032 117.432Z"
              fill="#428DFF"
            />
            <path
              d="M181.787 177.16L196.05 191.422C213.866 172.516 225.059 147.306 225.879 119.535H205.698C204.893 141.747 195.96 161.918 181.787 177.16ZM191.408 36.4449C172.503 18.6286 147.292 7.43579 119.521 6.61595V26.7966C141.734 27.6014 161.905 36.5344 177.147 50.707L191.409 36.4449H191.408ZM112.959 26.7966V6.61548C85.1892 7.43579 59.9803 18.63 41.0766 36.4491L55.3345 50.707C70.5764 36.5349 90.7467 27.6014 112.959 26.7966ZM205.698 112.973H225.879C225.059 85.2014 213.866 59.9906 196.05 41.085L181.787 55.3472C195.96 70.5891 204.893 90.7603 205.698 112.973ZM50.6935 55.3472L36.4364 41.0902C18.6249 59.9953 7.43579 85.2038 6.61548 112.973H26.7825C27.5874 90.7608 36.5203 70.5891 50.693 55.3472H50.6935Z"
              fill="#A4C3FD"
            />
            <path
              d="M199.201 116.254C199.201 70.5089 161.985 33.2925 116.24 33.2925C70.4952 33.2925 33.2793 70.5089 33.2793 116.254C33.2793 161.999 70.4957 199.215 116.24 199.215C161.984 199.215 199.201 161.999 199.201 116.254ZM156.321 121.315L123.131 166.474C121.492 168.724 119.042 169.97 116.24 169.97C113.459 169.97 111.014 168.73 109.353 166.479L76.1601 121.318C73.9363 118.288 73.9368 114.219 76.1591 111.191L109.349 66.0333C111.014 63.7776 113.46 62.5378 116.24 62.5378C119.04 62.5378 121.49 63.7819 123.136 66.0412L156.32 111.19C157.403 112.656 157.987 114.43 157.987 116.253C157.988 118.075 157.404 119.85 156.321 121.316V121.315Z"
              fill="#E8EDFC"
            />
            <path
              d="M119.521 205.711V225.892C147.293 225.071 172.503 213.879 191.409 196.063L177.147 181.801C161.905 195.973 141.734 204.906 119.521 205.711ZM117.843 69.9197L117.834 69.908C117.434 69.3567 116.926 69.1003 116.24 69.1003C115.56 69.1003 115.049 69.3624 114.634 69.9249L81.4486 115.076C80.9157 115.802 80.9157 116.706 81.45 117.433L114.638 162.588C115.049 163.145 115.559 163.407 116.24 163.407C116.927 163.407 117.434 163.151 117.834 162.6L151.032 117.431C151.565 116.706 151.565 115.801 151.031 115.074L117.843 69.9192L117.843 69.9197ZM26.783 119.535H6.61597C7.43628 147.304 18.6253 172.512 36.4364 191.417L50.6935 177.16C36.5213 161.918 27.5878 141.747 26.783 119.535ZM41.0766 196.058C59.9803 213.878 85.1888 225.072 112.959 225.892V205.711C90.7472 204.907 70.576 195.974 55.3341 181.801L41.0766 196.058Z"
              fill="#A4C3FD"
            />
          </svg>
        </Link>

        <svg
          width="16"
          height="16"
          viewBox="0 0 16 16"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M8 0C3.58214 0 0 3.58214 0 8C0 12.4178 3.58214 16 8 16C12.4178 16 16 12.4178 16 8C16 3.58214 12.4178 0 8 0ZM8.57143 11.8571C8.57143 11.9357 8.50712 12 8.42857 12H7.57143C7.49288 12 7.42857 11.9357 7.42857 11.8571V7C7.42857 6.92145 7.49288 6.85714 7.57143 6.85714H8.42857C8.50712 6.85714 8.57143 6.92145 8.57143 7V11.8571ZM8 5.71429C7.7757 5.70971 7.56213 5.61739 7.40511 5.45714C7.24815 5.2969 7.16015 5.08149 7.16015 4.85714C7.16015 4.6328 7.24815 4.41739 7.40511 4.25714C7.56213 4.0969 7.7757 4.00458 8 4C8.22431 4.00458 8.43787 4.0969 8.5949 4.25714C8.75185 4.41739 8.83985 4.6328 8.83985 4.85714C8.83985 5.08149 8.75185 5.2969 8.5949 5.45714C8.43787 5.61739 8.22431 5.70971 8 5.71429Z"
            fill="#40879A"
          />
        </svg>
        <Link to="/my-Wishlist">
          <svg
            width="17"
            height="16"
            viewBox="0 0 17 16"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M8.19051 15.9205L8.18441 15.9178L8.16523 15.9071C8.05302 15.8442 7.94171 15.7796 7.83133 15.7134C6.5043 14.9093 5.26414 13.9648 4.13144 12.8955C2.12544 10.987 0 8.15494 0 4.66685C0 2.06412 2.1481 6.30694e-05 4.74082 6.30694e-05C5.46158 -0.00353651 6.17386 0.158592 6.82469 0.474391C7.47552 0.79019 8.04815 1.25153 8.5 1.82411C8.95194 1.25142 9.52471 0.790001 10.1757 0.474198C10.8267 0.158394 11.5391 -0.00367036 12.2601 6.30694e-05C14.8519 6.30694e-05 17 2.06412 17 4.66685C17 8.15583 14.8746 10.9879 12.8686 12.8946C11.7359 13.964 10.4957 14.9085 9.16867 15.7125C9.05829 15.779 8.94698 15.8439 8.83477 15.9071L8.81559 15.9178L8.80949 15.9214L8.80687 15.9222C8.71234 15.9733 8.60698 16 8.5 16C8.39302 16 8.28766 15.9733 8.19313 15.9222L8.19051 15.9205Z"
              fill="#40879A"
            />
          </svg>
        </Link>
        <Link to="/cart">
          <svg
            width="18"
            height="16"
            viewBox="0 0 18 16"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M0 0.75C0 0.334375 0.337235 0 0.756414 0H2.19045C2.88383 0 3.49842 0.4 3.78522 1H16.7388C17.5677 1 18.1729 1.78125 17.9554 2.575L16.6632 7.33437C16.3953 8.31563 15.497 9 14.4727 9H5.38L5.55019 9.89062C5.61953 10.2437 5.93155 10.5 6.294 10.5H15.3804C15.7996 10.5 16.1368 10.8344 16.1368 11.25C16.1368 11.6656 15.7996 12 15.3804 12H6.294C5.2035 12 4.26744 11.2312 4.06573 10.1719L2.43944 1.70312C2.41737 1.58438 2.31337 1.5 2.19045 1.5H0.756414C0.337235 1.5 0 1.16562 0 0.75ZM4.03421 14.5C4.03421 14.303 4.07334 14.108 4.14937 13.926C4.22539 13.744 4.33683 13.5786 4.47731 13.4393C4.61779 13.3001 4.78456 13.1896 4.9681 13.1142C5.15165 13.0388 5.34837 13 5.54704 13C5.74571 13 5.94243 13.0388 6.12597 13.1142C6.30952 13.1896 6.47629 13.3001 6.61677 13.4393C6.75725 13.5786 6.86868 13.744 6.94471 13.926C7.02074 14.108 7.05987 14.303 7.05987 14.5C7.05987 14.697 7.02074 14.892 6.94471 15.074C6.86868 15.256 6.75725 15.4214 6.61677 15.5607C6.47629 15.6999 6.30952 15.8104 6.12597 15.8858C5.94243 15.9612 5.74571 16 5.54704 16C5.34837 16 5.15165 15.9612 4.9681 15.8858C4.78456 15.8104 4.61779 15.6999 4.47731 15.5607C4.33683 15.4214 4.22539 15.256 4.14937 15.074C4.07334 14.892 4.03421 14.697 4.03421 14.5ZM14.624 13C15.0252 13 15.41 13.158 15.6937 13.4393C15.9775 13.7206 16.1368 14.1022 16.1368 14.5C16.1368 14.8978 15.9775 15.2794 15.6937 15.5607C15.41 15.842 15.0252 16 14.624 16C14.2228 16 13.838 15.842 13.5543 15.5607C13.2706 15.2794 13.1112 14.8978 13.1112 14.5C13.1112 14.1022 13.2706 13.7206 13.5543 13.4393C13.838 13.158 14.2228 13 14.624 13Z"
              fill="#40879A"
            />
          </svg>
        </Link>

        {!isLoading && userProfile ? (
          <div className="relative">
            <button
              type="button"
              className="w-10 h-10 rounded-full object-cover cursor-pointer p-0 border-none bg-transparent"
              onClick={toggleDropdown}
              aria-label="Profile"
            >
              <img
                src={profilePhoto}
                alt="Profile"
                className="w-10 h-10 rounded-full object-cover"
                draggable={false}
              />
            </button>

            <span className="bg-base-100 absolute bottom-1 right-1 end-0 flex translate-x-2 translate-y-2 transform items-center rounded-full p-1">
              <img src={menuavatar} alt="" />
            </span>
            {dropdownVisible && (
              <div className="absolute right-0 mt-2 bg-white text-black shadow-md rounded-lg w-48">
                <ul>
                  <li>
                    <Link to="/profile" className="block px-4 py-2">
                      Profile
                    </Link>
                  </li>
                  <li>
                    <Link to="/settings" className="block px-4 py-2">
                      Settings
                    </Link>
                  </li>
                  <li>
                    <LogoutButton />
                  </li>
                </ul>
              </div>
            )}
          </div>
        ) : (
          <div className="w-10 h-10 rounded-full bg-gray-300" />
        )}
      </div>
    </header>
  );
};

export default Nav;
